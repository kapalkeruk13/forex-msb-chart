<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>MSB & OB PRO 2.0</title>
<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

<style>
body {
  margin:0;
  background:#0b0b0b;
  color:white;
  font-family:Arial;
}

#controls {
  padding:10px;
  background:#111;
  display:flex;
  gap:10px;
}

select {
  background:#1a1a1a;
  color:white;
  border:1px solid #333;
  padding:5px;
}

#chart {
  height:90vh;
}
</style>
</head>

<body>

<div id="controls">
  Pair:
  <select id="symbol">
    <option value="btcusdt">BTCUSDT</option>
    <option value="ethusdt">ETHUSDT</option>
  </select>

  TF:
  <select id="interval">
    <option value="1m" selected>1m</option>
    <option value="5m">5m</option>
    <option value="15m">15m</option>
    <option value="1h">1h</option>
  </select>
</div>

<div id="chart"></div>

<script>
const chart = LightweightCharts.createChart(
document.getElementById('chart'),
{
  layout:{background:{color:'#0b0b0b'},textColor:'#fff'},
  grid:{vertLines:{color:'#1f1f1f'},horzLines:{color:'#1f1f1f'}},
  width:window.innerWidth,
  height:window.innerHeight-60
});

const candleSeries = chart.addCandlestickSeries();

let socket;
let candles=[];
let swingHigh=null;
let swingLow=null;
let trend="none";
let orderBlocks=[];

function drawOB(ob){
  const series = chart.addAreaSeries({
    topColor: ob.type==="bull"?'rgba(0,255,0,0.25)':'rgba(255,0,0,0.25)',
    bottomColor: ob.type==="bull"?'rgba(0,255,0,0.05)':'rgba(255,0,0,0.05)',
    lineColor: ob.type==="bull"?'#00ff88':'#ff4444',
    lineWidth:1
  });

  series.setData([
    {time:ob.start,value:ob.high},
    {time:ob.end,value:ob.high}
  ]);

  ob.series=series;
}

function detectStructure(){
  if(candles.length<10) return;

  let latest=candles[candles.length-1];

  // Swing detect
  for(let i=candles.length-5;i<candles.length-2;i++){
    let p=candles[i-1],c=candles[i],n=candles[i+1];
    if(!p||!n) continue;

    if(c.high>p.high && c.high>n.high) swingHigh=c;
    if(c.low<p.low && c.low<n.low) swingLow=c;
  }

  // Bullish Break
  if(swingHigh && latest.close>swingHigh.high){
    trend="bull";

    let obCandle=null;
    for(let i=candles.length-2;i>=0;i--){
      if(candles[i].close<candles[i].open){
        obCandle=candles[i];
        break;
      }
    }

    if(obCandle){
      let ob={
        type:"bull",
        high:obCandle.high,
        low:obCandle.low,
        start:obCandle.time,
        end:latest.time+3600
      };
      orderBlocks.push(ob);
      drawOB(ob);
    }
  }

  // Bearish Break
  if(swingLow && latest.close<swingLow.low){
    trend="bear";

    let obCandle=null;
    for(let i=candles.length-2;i>=0;i--){
      if(candles[i].close>candles[i].open){
        obCandle=candles[i];
        break;
      }
    }

    if(obCandle){
      let ob={
        type:"bear",
        high:obCandle.high,
        low:obCandle.low,
        start:obCandle.time,
        end:latest.time+3600
      };
      orderBlocks.push(ob);
      drawOB(ob);
    }
  }

  // Invalidation
  orderBlocks.forEach(ob=>{
    if(ob.type==="bull" && latest.low<ob.low){
      ob.series.setData([]);
    }
    if(ob.type==="bear" && latest.high>ob.high){
      ob.series.setData([]);
    }
  });
}

function connect(symbol,interval){
  if(socket) socket.close();
  candles=[];
  orderBlocks=[];

  socket=new WebSocket(`wss://stream.binance.com:9443/ws/${symbol}@kline_${interval}`);

  socket.onmessage=(event)=>{
    let data=JSON.parse(event.data);
    let k=data.k;

    let candle={
      time:k.t/1000,
      open:+k.o,
      high:+k.h,
      low:+k.l,
      close:+k.c
    };

    candleSeries.update(candle);

    if(k.x){
      candles.push(candle);
      detectStructure();
    }
  }
}

connect("btcusdt","1m");

document.getElementById("symbol").onchange=function(){
connect(this.value,document.getElementById("interval").value);
}

document.getElementById("interval").onchange=function(){
connect(document.getElementById("symbol").value,this.value);
}
</script>

</body>
</html>
