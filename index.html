<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Forex MSB & Order Block Pro</title>

<script src="https://unpkg.com/lightweight-charts/dist/lightweight-charts.standalone.production.js"></script>

<style>
body {
  margin: 0;
  background: #0b0b0b;
  color: white;
  font-family: Arial, sans-serif;
}

#controls {
  padding: 10px;
  background: #111;
  display: flex;
  gap: 10px;
  align-items: center;
}

select {
  background: #1a1a1a;
  color: white;
  border: 1px solid #333;
  padding: 5px;
}

#chart {
  height: 90vh;
}
</style>
</head>

<body>

<div id="controls">
  Pair:
  <select id="symbol">
    <option value="btcusdt">BTCUSDT</option>
    <option value="ethusdt">ETHUSDT</option>
  </select>

  Timeframe:
  <select id="interval">
    <option value="1s">1s</option>
    <option value="5s">5s</option>
    <option value="1m" selected>1m</option>
    <option value="5m">5m</option>
    <option value="15m">15m</option>
    <option value="1h">1h</option>
  </select>
</div>

<div id="chart"></div>

<script>
// ================== CHART SETUP ==================
const chart = LightweightCharts.createChart(
  document.getElementById('chart'),
  {
    layout: {
      background: { color: '#0b0b0b' },
      textColor: '#ffffff'
    },
    grid: {
      vertLines: { color: '#1f1f1f' },
      horzLines: { color: '#1f1f1f' }
    },
    width: window.innerWidth,
    height: window.innerHeight - 60,
  }
);

const candleSeries = chart.addCandlestickSeries();

// MSB line
const msbLine = chart.addLineSeries({
  color: 'yellow',
  lineWidth: 2
});

// Order Block area
const obSeries = chart.addAreaSeries({
  topColor: 'rgba(0,255,0,0.25)',
  bottomColor: 'rgba(0,255,0,0.05)',
  lineColor: 'rgba(0,255,0,0.9)',
  lineWidth: 1,
});

// ================== VARIABLES ==================
let socket;
let candles = [];
let lastSwingHigh = null;
let lastSwingLow = null;

// ================== MSB + OB DETECTION ==================
function detectMSB() {

  if (candles.length < 10) return;

  const latest = candles[candles.length - 1];

  // ---- Detect Swing High / Low ----
  for (let i = candles.length - 5; i < candles.length - 2; i++) {

    const prev = candles[i - 1];
    const curr = candles[i];
    const next = candles[i + 1];
    if (!prev || !next) continue;

    if (curr.high > prev.high && curr.high > next.high) {
      lastSwingHigh = curr;
    }

    if (curr.low < prev.low && curr.low < next.low) {
      lastSwingLow = curr;
    }
  }

  // ---- Bullish MSB ----
  if (lastSwingHigh && latest.close > lastSwingHigh.high) {

    const impulse = latest;
    let avgBody = 0;

    for (let i = candles.length - 6; i < candles.length - 1; i++) {
      avgBody += Math.abs(candles[i].close - candles[i].open);
    }
    avgBody /= 5;

    if (Math.abs(impulse.close - impulse.open) > avgBody * 1.5) {

      msbLine.setData([
        { time: lastSwingHigh.time, value: lastSwingHigh.high },
        { time: latest.time, value: lastSwingHigh.high }
      ]);

      // Find last bearish candle (Bullish OB)
      for (let i = candles.length - 2; i >= 0; i--) {
        const c = candles[i];
        if (c.close < c.open) {
          obSeries.setData([
            { time: c.time, value: c.high },
            { time: latest.time + 600, value: c.high }
          ]);
          break;
        }
      }
    }
  }

  // ---- Bearish MSB ----
  if (lastSwingLow && latest.close < lastSwingLow.low) {

    const impulse = latest;
    let avgBody = 0;

    for (let i = candles.length - 6; i < candles.length - 1; i++) {
      avgBody += Math.abs(candles[i].close - candles[i].open);
    }
    avgBody /= 5;

    if (Math.abs(impulse.close - impulse.open) > avgBody * 1.5) {

      msbLine.setData([
        { time: lastSwingLow.time, value: lastSwingLow.low },
        { time: latest.time, value: lastSwingLow.low }
      ]);

      // Find last bullish candle (Bearish OB)
      for (let i = candles.length - 2; i >= 0; i--) {
        const c = candles[i];
        if (c.close > c.open) {
          obSeries.setData([
            { time: c.time, value: c.low },
            { time: latest.time + 600, value: c.low }
          ]);
          break;
        }
      }
    }
  }
}

// ================== DATA FEED ==================
function connect(symbol, interval) {

  if (socket) socket.close();
  candles = [];

  const url = `wss://stream.binance.com:9443/ws/${symbol}@kline_${interval}`;
  socket = new WebSocket(url);

  socket.onmessage = (event) => {
    const data = JSON.parse(event.data);
    const k = data.k;

    const candle = {
      time: k.t / 1000,
      open: parseFloat(k.o),
      high: parseFloat(k.h),
      low: parseFloat(k.l),
      close: parseFloat(k.c)
    };

    candleSeries.update(candle);

    if (k.x) {
      candles.push(candle);
      detectMSB();
    }
  };
}

// ================== UI EVENTS ==================
connect("btcusdt", "1m");

document.getElementById("symbol").onchange = function () {
  connect(this.value, document.getElementById("interval").value);
};

document.getElementById("interval").onchange = function () {
  connect(document.getElementById("symbol").value, this.value);
};
</script>

</body>
</html>
